<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Tour Sportsbook</title>
  <style>
    /* DraftKings-inspired color scheme */
    :root{
      --bg:#0d1117;
      --bg-dark:#000000;
      --card:#1a1f2e;
      --card-hover:#242938;
      --mut:#9ca3af;
      --text:#f5f5f5;
      --accent:#53d337;
      --accent-dark:#44a82a;
      --warn:#ffa500;
      --border:#2d3748;
      --border-light:#374151;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    .row{display:flex;gap:8px;align-items:center}
    .between{display:flex;align-items:center;justify-content:space-between}
    .card{background:var(--card);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);border:1px solid var(--border)}
    .card:hover{background:var(--card-hover)}
    h1{font-size:24px;margin:0;font-weight:700;letter-spacing:-0.5px}
    h2{font-size:18px;margin:0;font-weight:700;color:var(--text)}
    .pill{display:inline-block;padding:6px 12px;border-radius:6px;background:var(--bg-dark);color:var(--mut);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;border:1px solid var(--border)}
    .btn{border:2px solid var(--border);background:var(--card);color:var(--text);padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer;transition:all .2s;font-size:14px}
    .btn:hover{background:var(--card-hover);border-color:var(--border-light)}
    .btn:active{transform:scale(.97)}
    .btn.primary{background:var(--accent);color:#000;border-color:var(--accent);text-transform:uppercase;letter-spacing:0.5px}
    .btn.primary:hover{background:var(--accent-dark);border-color:var(--accent-dark)}
    .btn.small{padding:8px 12px;font-size:13px}
    .odds{display:flex;flex-wrap:wrap;gap:10px}
    .ticket{background:var(--bg-dark);border:2px solid var(--border);border-radius:8px;padding:12px;min-width:140px;cursor:pointer;transition:all .2s}
    .ticket:hover{border-color:var(--accent);background:var(--card)}
    .ticket .big{font-size:15px;font-weight:700;margin-bottom:6px;color:var(--text)}
    .ticket .odds-value{font-size:18px;font-weight:800;color:var(--accent);margin:4px 0}
    .mut{color:var(--mut);font-size:12px;font-weight:500}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tabs{display:flex;gap:12px;margin:12px 0}
    .tab{padding:10px 20px;border-radius:8px;background:var(--card);color:var(--mut);cursor:pointer;font-weight:600;border:2px solid var(--border);transition:all .2s}
    .tab:hover{background:var(--card-hover)}
    .tab.active{background:var(--accent);color:#000;border-color:var(--accent)}
    .slip{position:fixed;left:0;right:0;bottom:0;background:var(--bg-dark);border-top:2px solid var(--accent);padding:16px 16px calc(16px + env(safe-area-inset-bottom));box-shadow:0 -4px 20px rgba(0,0,0,.6)}
    input[type="number"],input[type="text"]{width:100%;padding:10px 12px;border-radius:8px;border:2px solid var(--border);background:var(--card);color:var(--text);font-size:14px;font-weight:500}
    input:focus{outline:none;border-color:var(--accent)}
    table{width:100%;border-collapse:collapse}
    td,th{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    th{font-weight:700;color:var(--mut);text-transform:uppercase;font-size:11px;letter-spacing:0.5px}
    .status-open{color:var(--mut)}
    .status-won{color:var(--accent);font-weight:700}
    .status-lost{color:#ff4444;font-weight:700}
    .status-push{color:var(--warn);font-weight:700}
    .diag{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
    .header-bar{background:var(--bg-dark);padding:12px 16px;border-bottom:2px solid var(--border);margin-bottom:16px}
    .logo{font-size:20px;font-weight:800;color:var(--accent);letter-spacing:-0.5px}
    .market-header{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--mut);margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid var(--border)}
    .slip-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;min-width:200px}
  </style>
</head>
<body>
<div class="header-bar">
  <div style="max-width:1100px;margin:0 auto" class="between">
    <div class="logo">⚡ TOUR SPORTSBOOK</div>
    <div class="row">
      <input id="userId" type="text" placeholder="Enter your name" style="width:180px"/>
      <button class="btn small" onclick="saveUser()">Save</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="between">
      <div class="tabs">
        <div id="tab-odds" class="tab active" onclick="showTab('odds')">Odds Board</div>
        <div id="tab-bets" class="tab" onclick="showTab('bets')">My Bets</div>
      </div>
      <div class="row" style="gap:12px">
        <div class="row" style="gap:6px">
          <span class="mut">Balance:</span>
          <span id="coins" style="font-weight:800;font-size:18px;color:var(--accent)">—</span>
          <span class="mut">coins</span>
        </div>
        <button class="btn small" onclick="refreshAll()">↻ Refresh</button>
        <button class="btn small" onclick="reprice()">⚡ Reprice</button>
      </div>
    </div>
  </div>

  <!-- Odds board -->
  <div id="screen-odds">
    <div id="board"></div>
  </div>

  <!-- My Bets -->
  <div id="screen-bets" style="display:none">
    <div class="card">
      <div class="between">
        <h2>Betting History</h2>
        <button class="btn small" onclick="loadMyBets()">↻ Refresh</button>
      </div>
    </div>
    <div class="card">
      <div id="betsTable" style="overflow-x:auto">Loading…</div>
    </div>
  </div>
</div>

<!-- Bet Slip -->
<div class="slip">
  <div class="between" style="margin-bottom:12px">
    <div class="row" style="gap:10px">
      <div style="font-size:16px;font-weight:800;color:var(--text)">BET SLIP</div>
      <div style="background:var(--accent);color:#000;padding:4px 10px;border-radius:12px;font-weight:800;font-size:13px" id="slipCount">0</div>
    </div>
    <button class="btn small" onclick="clearSlip()">Clear All</button>
  </div>
  <div id="slipItems" class="row" style="gap:10px;flex-wrap:wrap;margin-bottom:12px;max-height:120px;overflow-y:auto;"></div>
  <div class="grid">
    <div><input id="stake" type="number" min="1" placeholder="Enter stake (coins)" style="font-size:15px"/></div>
    <button class="btn primary" onclick="placeSlip()">Place Bet</button>
  </div>
  <div class="mut" id="slipNote" style="margin-top:8px;font-size:11px;text-align:center">Singles or parlays (no conflicting picks)</div>
</div>

<script>
  // ===== State =====
  let odds = [];
  let slip = [];
  let betsTimer = null;
  const $ = sel => document.querySelector(sel);

  // ===== Tabs =====
  function showTab(name){
    $('#tab-odds').classList.toggle('active', name==='odds');
    $('#tab-bets').classList.toggle('active', name==='bets');
    $('#screen-odds').style.display = name==='odds' ? '' : 'none';
    $('#screen-bets').style.display = name==='bets' ? '' : 'none';
    if (name==='bets'){
      loadMyBets();
      if (betsTimer) clearInterval(betsTimer);
      betsTimer = setInterval(loadMyBets, 10000);
    } else {
      if (betsTimer) { clearInterval(betsTimer); betsTimer = null; }
    }
  }

  // ===== User & Wallet =====
  function saveUser(){
    const id = $('#userId').value.trim() || 'guest';
    localStorage.setItem('tsb_user', id);
    loadWallet();
    if ($('#tab-bets').classList.contains('active')) loadMyBets();
  }
  function loadUser(){
    const id = localStorage.getItem('tsb_user') || 'guest';
    $('#userId').value = id;
    return id;
  }
  function loadWallet(){
    google.script.run.withSuccessHandler(w=>{
      $('#coins').textContent = (w && typeof w.coins_balance==='number') ? Math.round(w.coins_balance) : '—';
    }).getWallet(loadUser());
  }

  // ===== Odds Board =====
  function fmtOdds(n){ n = Number(n||0); return (n>0?'+':'') + n; }

  function renderBoard(){
    const host = $('#board');
    host.innerHTML = '';
    if (!odds.length){
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<div class="mut">No events found. Check Events & Lines tabs (and redeploy the web app after code changes).</div>`;
      host.appendChild(card);

      google.script.run.withSuccessHandler(d=>{
        const diag = document.createElement('div');
        diag.className = 'card diag';
        diag.innerText = JSON.stringify(d, null, 2);
        host.appendChild(diag);
      }).getOddsBoardDebug();
      return;
    }

    odds.forEach(ev=>{
      const card = document.createElement('div');
      card.className='card';
      const dateTxt = (ev.date ? new Date(ev.date).toLocaleString() : '');

      // Check which markets exist for this event
      const hasML = ev.markets.some(m=>m.market==='ML');
      const hasOU = ev.markets.some(m=>m.market==='OU');
      const hasSpread = ev.markets.some(m=>(m.market||'').toUpperCase()==='SPREAD');
      const hasH2HSeries = ev.markets.some(m=>(m.market||'').toUpperCase()==='H2H_SERIES');

      card.innerHTML = `
        <div class="between" style="margin-bottom:16px">
          <div>
            <div class="mut" style="margin-bottom:4px">${dateTxt}</div>
            <h2>${ev.map_label || ('Event '+ev.event_id)}</h2>
            <div class="mut" style="margin-top:2px">Event ID: ${ev.event_id} ${ev.series==='H2H'?'<span style="background:var(--accent);color:#000;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:800;margin-left:8px">2/3 SERIES</span>':''}</div>
          </div>
          <span class="pill">${ev.series || 'Tour'} • ${ev.mode || 'stroke'}</span>
        </div>

        ${hasH2HSeries ? '<div class="market-header">Series Winner (2/3)</div><div class="odds" id="h2h_'+ev.event_id+'"></div>' : ''}
        ${hasML ? '<div class="market-header">Moneyline</div><div class="odds" id="ml_'+ev.event_id+'"></div>' : ''}
        ${hasSpread ? '<div class="market-header">Head-to-Head Spread</div><div class="odds" id="sp_'+ev.event_id+'"></div>' : ''}
        ${hasOU ? '<div class="market-header">Player Over/Under</div><div class="odds" id="ou_'+ev.event_id+'"></div>' : ''}
      `;
      host.appendChild(card);

      // ===== ML tickets
      if (hasML) {
        const mlDiv = $('#ml_'+ev.event_id);
        ev.markets.filter(m=>m.market==='ML').forEach(m=>{
          const t=document.createElement('div'); t.className='ticket';
          t.innerHTML = `
            <div class="big">${m.selection}</div>
            <div class="mut">Moneyline</div>
            <div class="odds-value">${fmtOdds(m.american_odds)}</div>
            <button class="btn small" style="margin-top:8px;width:100%">Add to Slip</button>
          `;
          t.querySelector('button').onclick=()=>addToSlip({event_id: ev.event_id, market:'ML', selection:m.selection, param:m.param, odds:Number(m.american_odds)});
          mlDiv.appendChild(t);
        });
      }

      // ===== OU tickets grouped by player/line (supports multi-word names)
      if (hasOU) {
        const ouDiv = $('#ou_'+ev.event_id);
        const ouGroups = {};
        ev.markets.filter(m=>m.market==='OU').forEach(m=>{
          const player = String(m.selection).replace(/\s+(UNDER|OVER)$/i,'');
          const key = player + '|' + (m.param||'');
          if (!ouGroups[key]) {
            ouGroups[key] = {player:player, line:m.param, under:null, over:null};
          }
          if (/\sUNDER$/i.test(m.selection)) ouGroups[key].under=m; else ouGroups[key].over=m;
        });
        Object.values(ouGroups).forEach(g=>{
          if (!g.under || !g.over) return;
          const t=document.createElement('div'); t.className='ticket';
          t.innerHTML=`
            <div class="big">${g.player}</div>
            <div class="mut" style="margin:6px 0">Total: ${g.line}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
              <div style="text-align:center">
                <div style="font-size:11px;color:var(--mut);margin-bottom:4px">UNDER</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(g.under.american_odds)}</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:11px;color:var(--mut);margin-bottom:4px">OVER</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(g.over.american_odds)}</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
              <button class="btn small btn-under">Under</button>
              <button class="btn small btn-over">Over</button>
            </div>
          `;
          t.querySelector('.btn-under').onclick=()=>addToSlip({event_id: ev.event_id, market:'OU', selection:g.under.selection, param:g.under.param, odds:Number(g.under.american_odds)});
          t.querySelector('.btn-over').onclick=()=>addToSlip({event_id: ev.event_id, market:'OU', selection:g.over.selection,  param:g.over.param,  odds:Number(g.over.american_odds)});
          ouDiv.appendChild(t);
        });
      }

      // ===== H2H SERIES tickets
      if (hasH2HSeries) {
        const h2hDiv = $('#h2h_'+ev.event_id);
        const h2hMarkets = ev.markets.filter(m => (m.market||'').toUpperCase() === 'H2H_SERIES');

        h2hMarkets.forEach(m=>{
          const t = document.createElement('div');
          t.className='ticket';
          t.style.minWidth = '200px';
          t.innerHTML = `
            <div class="big">${m.selection}</div>
            <div class="mut" style="margin:6px 0">Best of 3 Series</div>
            <div class="odds-value">${fmtOdds(m.american_odds)}</div>
            <button class="btn small" style="margin-top:8px;width:100%">Add to Slip</button>
          `;
          t.querySelector('button').onclick = () => addToSlip({
            event_id: ev.event_id,
            market: 'H2H_SERIES',
            selection: m.selection,
            param: m.param || '',
            odds: Number(m.american_odds)
          });
          h2hDiv.appendChild(t);
        });
      }

      // ===== SPREAD tickets (robust parse + grouping) - FIXED
      if (hasSpread) {
        const spDiv = $('#sp_'+ev.event_id);
        const spGroups = {};
        const spreadMarkets = ev.markets.filter(m => (m.market||'').toUpperCase() === 'SPREAD');

        console.log('Spread markets found:', spreadMarkets.length, 'for event', ev.event_id);

        spreadMarkets.forEach(m=>{
          // Parse player and numeric line from selection string
          let player = '', line = null;
          const selStr = String(m.selection||'');
          const mm = selStr.match(/^(.*)\s+([+-]?\d+(?:\.\d+)?)$/);

          if (mm) {
            player = mm[1].trim();
            line = Number(mm[2]);
          }

          // If param exists and is valid, use it for the line value (it should be signed correctly from backend)
          if (m.param !== undefined && m.param !== null && m.param !== "" && !isNaN(Number(m.param))) {
            line = Number(m.param);
          }

          console.log('Parsed spread:', {player, line, selection: m.selection, param: m.param});

          if (!player || !isFinite(line)) {
            console.warn('Invalid spread data:', m);
            return;
          }

          const key = String(Math.abs(line).toFixed(1));     // group by absolute value
          const label = Math.abs(line).toFixed(1);

          // Initialize group if it doesn't exist (compatible with older JS engines)
          if (!spGroups[key]) {
            spGroups[key] = { label: label, sides: {} };
          }

          // Store with numeric param for slip
          spGroups[key].sides[player] = {
            selection: m.selection,
            american_odds: m.american_odds,
            param: line,
            market: m.market
          };
        });

        console.log('Spread groups:', spGroups);

        Object.values(spGroups).forEach(g=>{
          const players = Object.keys(g.sides);
          if (players.length < 2) {
            console.warn('Not enough players for spread group:', g);
            return;
          }

          players.sort();
          const p1 = players[0], p2 = players[1];
          const m1 = g.sides[p1], m2 = g.sides[p2];

          const t = document.createElement('div');
          t.className='ticket';
          t.style.minWidth = '280px';
          t.innerHTML = `
            <div class="mut" style="margin-bottom:8px">SPREAD ${g.label}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div style="text-align:center;padding:8px;background:var(--card);border-radius:6px">
                <div style="font-size:13px;font-weight:700;margin-bottom:4px">${p1}</div>
                <div style="font-size:12px;color:var(--mut);margin-bottom:4px">${m1.selection.match(/[+-]\d+(?:\.\d+)?$/)?.[0] || ''}</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(m1.american_odds)}</div>
              </div>
              <div style="text-align:center;padding:8px;background:var(--card);border-radius:6px">
                <div style="font-size:13px;font-weight:700;margin-bottom:4px">${p2}</div>
                <div style="font-size:12px;color:var(--mut);margin-bottom:4px">${m2.selection.match(/[+-]\d+(?:\.\d+)?$/)?.[0] || ''}</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(m2.american_odds)}</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
              <button class="btn small btn-spread-a">${p1}</button>
              <button class="btn small btn-spread-b">${p2}</button>
            </div>
          `;
          t.querySelector('.btn-spread-a').onclick = () => addToSlip({
            event_id: ev.event_id,
            market: 'SPREAD',
            selection: m1.selection,
            param: m1.param,
            odds: Number(m1.american_odds)
          });
          t.querySelector('.btn-spread-b').onclick = () => addToSlip({
            event_id: ev.event_id,
            market: 'SPREAD',
            selection: m2.selection,
            param: m2.param,
            odds: Number(m2.american_odds)
          });
          spDiv.appendChild(t);
        });
      }
    });
  }

  // ===== Slip =====
  function amToDecimal(am){ const a=Number(am); return a>=0 ? 1+a/100 : 1+100/Math.abs(a); }

  function calculateParlayOdds(legs){
    if (!legs || legs.length === 0) return {decimal: 1, american: 0};
    const decimal = legs.reduce((acc, leg) => acc * amToDecimal(leg.odds), 1);
    const american = decimal >= 2 ? Math.round((decimal-1)*100) : Math.round(-100/(decimal-1));
    return {decimal, american};
  }

  function validateParlayClient(legs){
    if (legs.length < 2) return {valid: true}; // Not a parlay
    if (legs.length > 20) return {valid: false, error: "Maximum 20 legs per parlay"};

    // Group by event_id and market type
    const groups = {}; // {event_id: {ML: [...], SPREAD: [...], OU: [...]}}

    for (const lg of legs){
      const evt = lg.event_id;
      const mkt = (lg.market||'').toUpperCase();

      if (!groups[evt]) groups[evt] = {};
      if (!groups[evt][mkt]) groups[evt][mkt] = [];
      groups[evt][mkt].push(lg);
    }

    // Check for conflicts within each event/market
    for (const evt in groups){
      for (const mkt in groups[evt]){
        const legsInMarket = groups[evt][mkt];

        if (mkt === 'ML'){
          // Cannot have multiple different ML picks
          if (legsInMarket.length > 1){
            const selections = legsInMarket.map(l => l.selection);
            const unique = [...new Set(selections)];
            if (unique.length > 1){
              return {valid: false, error: `Cannot parlay conflicting ML picks: ${unique.join(' vs ')}`};
            }
          }
        } else if (mkt === 'SPREAD'){
          // Cannot bet both sides of spread
          if (legsInMarket.length > 1){
            return {valid: false, error: 'Cannot parlay both sides of spread'};
          }
        } else if (mkt === 'OU'){
          // Cannot have Over AND Under for same player
          const playerSides = {};
          for (const lg of legsInMarket){
            const player = lg.selection.replace(/\s+(UNDER|OVER)$/i, '').trim();
            const sideMatch = lg.selection.match(/\s+(UNDER|OVER)$/i);
            const side = sideMatch ? sideMatch[1].toUpperCase() : '';
            if (!playerSides[player]) playerSides[player] = [];
            playerSides[player].push(side);
          }
          for (const player in playerSides){
            if (playerSides[player].includes('OVER') && playerSides[player].includes('UNDER')){
              return {valid: false, error: `Cannot parlay Over and Under for ${player}`};
            }
          }
        } else if (mkt === 'H2H_SERIES'){
          // Cannot bet both series winners
          if (legsInMarket.length > 1){
            return {valid: false, error: 'Cannot parlay both series winners'};
          }
        }
      }
    }

    return {valid: true};
  }

  function addToSlip(sel){
    // Check for conflicting bets
    const testSlip = [...slip, sel];
    const validation = validateParlayClient(testSlip);
    if (!validation.valid){
      alert(validation.error);
      return;
    }

    slip.push(sel);
    renderSlip();
  }

  function clearSlip(){ slip=[]; renderSlip(); }

  function renderSlip(){
    const host = $('#slipItems');
    $('#slipCount').textContent = slip.length;
    host.innerHTML='';

    const isParlay = slip.length > 1;
    const parlayOdds = isParlay ? calculateParlayOdds(slip) : null;

    slip.forEach((s,idx)=>{
      const div=document.createElement('div');
      div.className='slip-item';
      div.innerHTML = `
        <div class="between" style="margin-bottom:6px">
          <div class="mut" style="font-size:10px;text-transform:uppercase">${s.market} • ${s.event_id}</div>
          <button class="btn small" style="padding:4px 8px;font-size:11px" onclick="event.stopPropagation()">×</button>
        </div>
        <div style="font-weight:700;font-size:13px;margin-bottom:4px">${s.selection}</div>
        ${s.param?`<div class="mut" style="font-size:11px;margin-bottom:4px">Line: ${s.param}</div>`:''}
        <div style="font-size:14px;color:var(--mut)">${fmtOdds(s.odds)}</div>
      `;
      div.querySelector('button').onclick=()=>{ slip.splice(idx,1); renderSlip(); };
      host.appendChild(div);
    });

    if (slip.length === 0) {
      host.innerHTML = '<div style="color:var(--mut);font-size:13px;text-align:center;width:100%;padding:20px">Select bets to add to slip</div>';
      $('#slipNote').textContent = 'Add bets to your slip. Same event parlays allowed!';
    } else {
      // Show parlay summary if multiple legs
      if (isParlay){
        const summaryDiv = document.createElement('div');
        summaryDiv.style.cssText = 'background:var(--accent);color:#000;padding:12px;border-radius:8px;font-weight:800;margin-top:8px';
        const stake = Number($('#stake').value || 0);
        const potentialPayout = stake > 0 ? (stake * parlayOdds.decimal).toFixed(2) : '—';
        summaryDiv.innerHTML = `
          <div style="font-size:11px;margin-bottom:4px;opacity:0.8">${slip.length}-LEG PARLAY</div>
          <div style="font-size:20px;margin-bottom:4px">${fmtOdds(parlayOdds.american)}</div>
          ${stake > 0 ? `<div style="font-size:13px">Potential Payout: ${potentialPayout} coins</div>` : ''}
        `;
        host.appendChild(summaryDiv);
        $('#slipNote').textContent = `${slip.length}-leg parlay - All legs must win. Same event parlays allowed!`;
      } else {
        $('#slipNote').textContent = 'Single bet - Enter stake and place';
      }
    }
  }

  // ===== Backend hooks =====
  function refreshAll(){
    google.script.run
      .withSuccessHandler(data=>{ odds = data || []; renderBoard(); loadWallet(); })
      .withFailureHandler(err=>{ alert('Failed to load board: '+(err && err.message ? err.message : err)); })
      .getOddsBoard();
  }
  function reprice(){
    google.script.run
      .withSuccessHandler(res=>{
        if (!res || !res.ok){ alert('Reprice failed' + (res && res.error ? (': '+res.error) : '')); return; }
        refreshAll();
      })
      .withFailureHandler(err=> alert('Reprice error: '+(err && err.message ? err.message : err)))
      .repriceNow();
  }
  function placeSlip(){
    const id = loadUser();
    const stake = Number($('#stake').value||0);
    if (!stake || stake<=0){ alert('Enter a stake > 0'); return; }
    if (!slip.length){ alert('No selections'); return; }
    const payload = slip.length===1
      ? { user_id:id, stake, type:'single', selection:slip[0] }
      : { user_id:id, stake, type:'parlay', legs:slip };
    google.script.run
      .withSuccessHandler(res=>{
        if (res && res.ok){
          $('#stake').value='';
          clearSlip();
          loadWallet();
          loadMyBets();
          alert('Bet placed!');
        } else {
          alert('Failed to place bet.');
        }
      })
      .withFailureHandler(err=> alert('Error: '+(err && err.message ? err.message : err)))
      .placeBet(payload);
  }

  // ===== My Bets =====
  function loadMyBets(){ google.script.run.withSuccessHandler(renderMyBets).listMyBets(loadUser()); }
  function renderMyBets(rows){
    const host=$('#betsTable');
    if (!rows||!rows.length){ host.textContent='No bets yet.'; return; }
    let html=`<table><thead><tr><th>Time</th><th>Type</th><th>Event</th><th>Selection</th><th>Line</th><th>Odds</th><th>Stake</th><th>Status</th><th>Payout</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      const ts=r.timestamp?new Date(r.timestamp).toLocaleString():'';
      const type=(String(r.is_parlay)==="TRUE"||r.is_parlay===true)?'PARLAY':r.market;
      const raw=(r.status||'open').toLowerCase();
      const statusDisplay = raw==='open' ? 'PENDING' : raw.toUpperCase();
      const cls = raw==='won'?'status-won':raw==='lost'?'status-lost':raw==='push'?'status-push':'status-open';
      html+=`<tr class="${cls}">
        <td>${ts}</td><td>${type}</td><td>${r.event_id||''}</td>
        <td>${r.selection||''}</td><td>${r.param||''}</td>
        <td>${(Number(r.odds)>0?'+':'')+Number(r.odds)}</td><td>${Math.round(Number(r.stake||0))}</td>
        <td style="text-transform:none">${statusDisplay}</td>
        <td>${r.settled_payout?Math.round(Number(r.settled_payout)):''}</td>
      </tr>`;
    });
    host.innerHTML=html+'</tbody></table>';
  }

  // ===== Real-time payout calculator =====
  function setupStakeListener(){
    const stakeInput = $('#stake');
    if (stakeInput){
      stakeInput.addEventListener('input', ()=>{ renderSlip(); });
    }
  }

  // ===== Boot =====
  (function init(){
    loadUser();
    refreshAll();
    renderSlip();
    setupStakeListener();
  })();
</script>
</body>
</html>
