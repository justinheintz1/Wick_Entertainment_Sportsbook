<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Tour Sportsbook</title>
  <style>
    :root{--bg:#0b1020;--card:#141a2a;--mut:#8ea0c2;--text:#e8eefc;--accent:#47d18c;--warn:#ffb020;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:12px 12px 96px}
    .row{display:flex;gap:8px;align-items:center}
    .between{display:flex;align-items:center;justify-content:space-between}
    .card{background:var(--card);border-radius:16px;padding:12px;margin:10px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
    h1{font-size:20px;margin:8px 0 4px}
    h2{font-size:16px;margin:8px 0 6px;color:var(--mut)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#1e2740;color:#cfe0ff;font-size:12px}
    .btn{border:1px solid #334;background:#1a2340;color:#cfe0ff;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .btn.primary{background:var(--accent);color:#032614;border-color:#43be7f}
    .btn.small{padding:6px 8px;font-size:13px}
    .odds{display:flex;flex-wrap:wrap;gap:8px}
    .ticket{background:#0f1528;border:1px solid #2a3554;border-radius:12px;padding:10px;min-width:130px}
    .ticket .big{font-size:16px;font-weight:800}
    .mut{color:var(--mut)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .tabs{display:flex;gap:8px;margin:8px 0}
    .tab{padding:8px 10px;border-radius:999px;background:#1e2740;color:#cfe0ff;cursor:pointer}
    .tab.active{background:var(--accent);color:#042a16}
    .slip{position:fixed;left:0;right:0;bottom:0;background:#0c1325;border-top:1px solid #2a3554;padding:12px 12px calc(12px + env(safe-area-inset-bottom))}
    input[type="number"],input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #334;background:#0b1327;color:#e8eefc}
    table{width:100%;border-collapse:collapse}
    td,th{padding:8px;border-bottom:1px solid #2a3554;font-size:13px}
    .status-open{color:#cfe0ff}
    .status-won{color:#33d18a;font-weight:700}
    .status-lost{color:#ff6a6a;font-weight:700}
    .status-push{color:#ffb020;font-weight:700}
    .diag{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap}
  </style>
</head>
<body>
<div class="wrap">
  <div class="between card">
    <div>
      <div class="mut" style="font-size:12px">Tour Sportsbook</div>
      <h1>Sportsbook</h1>
      <div class="tabs">
        <div id="tab-odds" class="tab active" onclick="showTab('odds')">Odds Board</div>
        <div id="tab-bets" class="tab" onclick="showTab('bets')">My Bets</div>
      </div>
    </div>
    <div class="row">
      <input id="userId" type="text" placeholder="Your name (wallet id)" style="width:160px"/>
      <button class="btn small" onclick="saveUser()">Save</button>
    </div>
  </div>

  <div id="wallet" class="card between">
    <div class="row"><span class="mut">Coins:</span> <span id="coins" style="font-weight:800;margin-left:8px">—</span></div>
    <div class="row" style="gap:8px">
      <button class="btn small" onclick="refreshAll()">Refresh</button>
      <button class="btn small" onclick="reprice()">Reprice</button>
    </div>
  </div>

  <!-- Odds board -->
  <div id="screen-odds">
    <div id="board"></div>
  </div>

  <!-- My Bets -->
  <div id="screen-bets" style="display:none">
    <div class="card between">
      <h2>Betting History</h2>
      <button class="btn small" onclick="loadMyBets()">Refresh</button>
    </div>
    <div class="card">
      <div id="betsTable">Loading…</div>
    </div>
  </div>
</div>

<!-- Bet Slip -->
<div class="slip">
  <div class="between">
    <div class="row"><strong>Bet Slip</strong> <span class="mut" id="slipCount">(0)</span></div>
    <button class="btn small" onclick="clearSlip()">Clear</button>
  </div>
  <div id="slipItems" class="row" style="gap:8px;flex-wrap:wrap;margin:8px 0;"></div>
  <div class="grid">
    <div><input id="stake" type="number" min="1" placeholder="Stake (coins)"/></div>
    <button class="btn primary" onclick="placeSlip()">Place Bet</button>
  </div>
  <div class="mut" id="slipNote" style="margin-top:6px;font-size:12px">Singles or parlays (max 1 leg per event).</div>
</div>

<script>
  // ===== State =====
  let odds = [];
  let slip = [];
  let betsTimer = null;
  const $ = sel => document.querySelector(sel);

  // ===== Tabs =====
  function showTab(name){
    $('#tab-odds').classList.toggle('active', name==='odds');
    $('#tab-bets').classList.toggle('active', name==='bets');
    $('#screen-odds').style.display = name==='odds' ? '' : 'none';
    $('#screen-bets').style.display = name==='bets' ? '' : 'none';
    if (name==='bets'){
      loadMyBets();
      if (betsTimer) clearInterval(betsTimer);
      betsTimer = setInterval(loadMyBets, 10000);
    } else {
      if (betsTimer) { clearInterval(betsTimer); betsTimer = null; }
    }
  }

  // ===== User & Wallet =====
  function saveUser(){
    const id = $('#userId').value.trim() || 'guest';
    localStorage.setItem('tsb_user', id);
    loadWallet();
    if ($('#tab-bets').classList.contains('active')) loadMyBets();
  }
  function loadUser(){
    const id = localStorage.getItem('tsb_user') || 'guest';
    $('#userId').value = id;
    return id;
  }
  function loadWallet(){
    google.script.run.withSuccessHandler(w=>{
      $('#coins').textContent = (w && typeof w.coins_balance==='number') ? Math.round(w.coins_balance) : '—';
    }).getWallet(loadUser());
  }

  // ===== Odds Board =====
  function fmtOdds(n){ n = Number(n||0); return (n>0?'+':'') + n; }

  function renderBoard(){
    const host = $('#board');
    host.innerHTML = '';
    if (!odds.length){
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<div class="mut">No events found. Check Events & Lines tabs (and redeploy the web app after code changes).</div>`;
      host.appendChild(card);

      google.script.run.withSuccessHandler(d=>{
        const diag = document.createElement('div');
        diag.className = 'card diag';
        diag.innerText = JSON.stringify(d, null, 2);
        host.appendChild(diag);
      }).getOddsBoardDebug();
      return;
    }

    odds.forEach(ev=>{
      const card = document.createElement('div');
      card.className='card';
      const dateTxt = (ev.date ? new Date(ev.date).toLocaleString() : '');
      card.innerHTML = `
        <div class="between">
          <div>
            <div class="mut" style="font-size:12px">${dateTxt}</div>
            <h2>${ev.map_label || ('Event '+ev.event_id)}</h2>
            <div class="mut" style="font-size:12px">Event ${ev.event_id}</div>
          </div>
          <span class="pill">${ev.series || 'Tour'} • ${ev.mode || 'stroke'}</span>
        </div>

        <div style="margin-top:8px">
          <div class="mut" style="margin-bottom:6px">Moneyline</div>
          <div class="odds" id="ml_${ev.event_id}"></div>
        </div>

        <div style="margin-top:10px">
          <div class="mut" style="margin-bottom:6px">Player Over/Under</div>
          <div class="odds" id="ou_${ev.event_id}"></div>
        </div>

        <div style="margin-top:10px">
          <div class="mut" style="margin-bottom:6px">Head-to-Head Spread</div>
          <div class="odds" id="sp_${ev.event_id}"></div>
        </div>
      `;
      host.appendChild(card);

      // ===== ML tickets
      const mlDiv = $('#ml_'+ev.event_id);
      ev.markets.filter(m=>m.market==='ML').forEach(m=>{
        const t=document.createElement('div'); t.className='ticket';
        t.innerHTML = `
          <div class="big">${m.selection}</div>
          <div class="mut">Odds</div>
          <div>${fmtOdds(m.american_odds)}</div>
          <button class="btn small" style="margin-top:6px">Add</button>
        `;
        t.querySelector('button').onclick=()=>addToSlip({event_id: ev.event_id, market:'ML', selection:m.selection, param:m.param, odds:Number(m.american_odds)});
        mlDiv.appendChild(t);
      });

      // ===== OU tickets grouped by player/line (supports multi-word names)
      const ouDiv = $('#ou_'+ev.event_id);
      const ouGroups = {};
      ev.markets.filter(m=>m.market==='OU').forEach(m=>{
        const player = String(m.selection).replace(/\s+(UNDER|OVER)$/i,'');
        const key = player + '|' + (m.param||'');
        (ouGroups[key]||(ouGroups[key]={player,line:m.param,under:null,over:null}));
        if (/\sUNDER$/i.test(m.selection)) ouGroups[key].under=m; else ouGroups[key].over=m;
      });
      Object.values(ouGroups).forEach(g=>{
        if (!g.under || !g.over) return;
        const t=document.createElement('div'); t.className='ticket';
        t.innerHTML=`
          <div class="big">${g.player}</div>
          <div class="mut">Line: ${g.line}</div>
          <div class="row" style="gap:6px;margin-top:6px">
            <button class="btn small">Under ${fmtOdds(g.under.american_odds)}</button>
            <button class="btn small">Over  ${fmtOdds(g.over.american_odds)}</button>
          </div>
        `;
        const [uBtn,oBtn]=t.querySelectorAll('button');
        uBtn.onclick=()=>addToSlip({event_id: ev.event_id, market:'OU', selection:g.under.selection, param:g.under.param, odds:Number(g.under.american_odds)});
        oBtn.onclick=()=>addToSlip({event_id: ev.event_id, market:'OU', selection:g.over.selection,  param:g.over.param,  odds:Number(g.over.american_odds)});
        ouDiv.appendChild(t);
      });

      // ===== SPREAD tickets (robust parse + grouping)
      const spDiv = $('#sp_'+ev.event_id);
      const spGroups = {};
      ev.markets.filter(m => (m.market||'').toUpperCase() === 'SPREAD').forEach(m=>{
        // Parse player and numeric line from either selection or param
        let player = '', line = null;
        const mm = String(m.selection||'').match(/^(.*)\s+([+-]?\d+(?:\.\d+)?)$/);
        if (mm){ player = mm[1].trim(); line = Number(mm[2]); }
        if ((m.param!==undefined && m.param!=="") && !isNaN(Number(m.param))) line = Number(m.param);
        if (!player || !isFinite(line)) return;

        const key = String(Math.abs(line).toFixed(1));     // group by absolute value
        const label = `±${Math.abs(line).toFixed(1)}`;
        (spGroups[key] ||= { label, sides:{} });
        spGroups[key].sides[player] = {...m, param: line}; // ensure numeric param flows to slip
      });

      Object.values(spGroups).forEach(g=>{
        const players = Object.keys(g.sides);
        if (players.length < 2) return;                    // need both sides
        players.sort();
        const p1 = players[0], p2 = players[1];
        const m1 = g.sides[p1], m2 = g.sides[p2];

        const t = document.createElement('div'); t.className='ticket';
        t.innerHTML = `
          <div class="big">Line: ${g.label}</div>
          <div class="row" style="gap:6px;margin-top:6px;flex-wrap:wrap">
            <button class="btn small">${m1.selection} ${fmtOdds(m1.american_odds)}</button>
            <button class="btn small">${m2.selection} ${fmtOdds(m2.american_odds)}</button>
          </div>
        `;
        const [aBtn,bBtn]=t.querySelectorAll('button');
        aBtn.onclick = () => addToSlip({event_id: ev.event_id, market:'SPREAD', selection:m1.selection, param:m1.param, odds:Number(m1.american_odds)});
        bBtn.onclick = () => addToSlip({event_id: ev.event_id, market:'SPREAD', selection:m2.selection, param:m2.param, odds:Number(m2.american_odds)});
        spDiv.appendChild(t);
      });
    });
  }

  // ===== Slip =====
  function addToSlip(sel){
    const sameEvent = slip.find(l=>l.event_id===sel.event_id);
    if (sameEvent){ alert('Parlay rule: only one leg per event.'); return; }
    slip.push(sel); renderSlip();
  }
  function clearSlip(){ slip=[]; renderSlip(); }
  function renderSlip(){
    const host = $('#slipItems');
    $('#slipCount').textContent = `(${slip.length})`;
    host.innerHTML='';
    slip.forEach((s,idx)=>{
      const div=document.createElement('div'); div.className='ticket';
      div.innerHTML = `
        <div class="mut">${s.market} • ${s.event_id}</div>
        <div style="font-weight:700">${s.selection}</div>
        <div class="mut">${s.param?('Line: '+s.param):''}</div>
        <div>${fmtOdds(s.odds)}</div>
        <button class="btn small" style="margin-top:6px">Remove</button>
      `;
      div.querySelector('button').onclick=()=>{ slip.splice(idx,1); renderSlip(); };
      host.appendChild(div);
    });
    $('#slipNote').textContent = slip.length>1 ? 'Parlay selected (1 leg per event).' : 'Single bet. Enter stake.';
  }

  // ===== Backend hooks =====
  function refreshAll(){
    google.script.run
      .withSuccessHandler(data=>{ odds = data || []; renderBoard(); loadWallet(); })
      .withFailureHandler(err=>{ alert('Failed to load board: '+(err && err.message ? err.message : err)); })
      .getOddsBoard();
  }
  function reprice(){
    google.script.run
      .withSuccessHandler(res=>{
        if (!res || !res.ok){ alert('Reprice failed' + (res && res.error ? (': '+res.error) : '')); return; }
        refreshAll();
      })
      .withFailureHandler(err=> alert('Reprice error: '+(err && err.message ? err.message : err)))
      .repriceNow();
  }
  function placeSlip(){
    const id = loadUser();
    const stake = Number($('#stake').value||0);
    if (!stake || stake<=0){ alert('Enter a stake > 0'); return; }
    if (!slip.length){ alert('No selections'); return; }
    const payload = slip.length===1
      ? { user_id:id, stake, type:'single', selection:slip[0] }
      : { user_id:id, stake, type:'parlay', legs:slip };
    google.script.run
      .withSuccessHandler(res=>{
        if (res && res.ok){
          $('#stake').value='';
          clearSlip();
          loadWallet();
          loadMyBets();
          alert('Bet placed!');
        } else {
          alert('Failed to place bet.');
        }
      })
      .withFailureHandler(err=> alert('Error: '+(err && err.message ? err.message : err)))
      .placeBet(payload);
  }

  // ===== My Bets =====
  function loadMyBets(){ google.script.run.withSuccessHandler(renderMyBets).listMyBets(loadUser()); }
  function renderMyBets(rows){
    const host=$('#betsTable');
    if (!rows||!rows.length){ host.textContent='No bets yet.'; return; }
    let html=`<table><thead><tr><th>Time</th><th>Type</th><th>Event</th><th>Selection</th><th>Line</th><th>Odds</th><th>Stake</th><th>Status</th><th>Payout</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      const ts=r.timestamp?new Date(r.timestamp).toLocaleString():'';
      const type=(String(r.is_parlay)==="TRUE"||r.is_parlay===true)?'PARLAY':r.market;
      const raw=(r.status||'open').toLowerCase();
      const statusDisplay = raw==='open' ? 'PENDING' : raw.toUpperCase();
      const cls = raw==='won'?'status-won':raw==='lost'?'status-lost':raw==='push'?'status-push':'status-open';
      html+=`<tr class="${cls}">
        <td>${ts}</td><td>${type}</td><td>${r.event_id||''}</td>
        <td>${r.selection||''}</td><td>${r.param||''}</td>
        <td>${(Number(r.odds)>0?'+':'')+Number(r.odds)}</td><td>${Math.round(Number(r.stake||0))}</td>
        <td style="text-transform:none">${statusDisplay}</td>
        <td>${r.settled_payout?Math.round(Number(r.settled_payout)):''}</td>
      </tr>`;
    });
    host.innerHTML=html+'</tbody></table>';
  }

  // ===== Boot =====
  (function init(){ loadUser(); refreshAll(); renderSlip(); })();
</script>
</body>
</html>
