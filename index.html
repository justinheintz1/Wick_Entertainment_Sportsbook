<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Tour Sportsbook</title>
  <style>
    /* DraftKings-inspired color scheme */
    :root{
      --bg:#0d1117;
      --bg-dark:#000000;
      --card:#1a1f2e;
      --card-hover:#242938;
      --mut:#9ca3af;
      --text:#f5f5f5;
      --accent:#53d337;
      --accent-dark:#44a82a;
      --warn:#ffa500;
      --border:#2d3748;
      --border-light:#374151;
      --selected-cell:#1e3a1e;  /* Dark green for selected cells */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    .row{display:flex;gap:8px;align-items:center}
    .between{display:flex;align-items:center;justify-content:space-between}
    .card{background:var(--card);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);border:1px solid var(--border)}
    .card:hover{background:var(--card-hover)}
    h1{font-size:24px;margin:0;font-weight:700;letter-spacing:-0.5px}
    h2{font-size:18px;margin:0;font-weight:700;color:var(--text)}
    .pill{display:inline-block;padding:6px 12px;border-radius:6px;background:var(--bg-dark);color:var(--mut);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;border:1px solid var(--border)}
    .btn{border:2px solid var(--border);background:var(--card);color:var(--text);padding:10px 16px;border-radius:8px;font-weight:700;cursor:pointer;transition:all .2s;font-size:14px}
    .btn:hover{background:var(--card-hover);border-color:var(--border-light)}
    .btn:active{transform:scale(.97)}
    .btn.primary{background:var(--accent);color:#000;border-color:var(--accent);text-transform:uppercase;letter-spacing:0.5px}
    .btn.primary:hover{background:var(--accent-dark);border-color:var(--accent-dark)}
    .btn.small{padding:8px 12px;font-size:13px}
    .odds{display:flex;flex-wrap:wrap;gap:10px}
    .ticket{background:var(--bg-dark);border:2px solid var(--border);border-radius:8px;padding:12px;min-width:140px;cursor:pointer;transition:all .2s}
    .ticket:hover{border-color:var(--accent);background:var(--card)}
    .ticket .big{font-size:15px;font-weight:700;margin-bottom:6px;color:var(--text)}
    .ticket .odds-value{font-size:18px;font-weight:800;color:var(--accent);margin:4px 0}
    .mut{color:var(--mut);font-size:12px;font-weight:500}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tabs{display:flex;gap:12px;margin:12px 0}
    .tab{padding:10px 20px;border-radius:8px;background:var(--card);color:var(--mut);cursor:pointer;font-weight:600;border:2px solid var(--border);transition:all .2s}
    .tab:hover{background:var(--card-hover)}
    .tab.active{background:var(--accent);color:#000;border-color:var(--accent)}
    .slip{position:fixed;left:0;right:0;bottom:0;background:var(--bg-dark);border-top:2px solid var(--accent);padding:16px 16px calc(16px + env(safe-area-inset-bottom));box-shadow:0 -4px 20px rgba(0,0,0,.6)}
    input[type="number"],input[type="text"]{width:100%;padding:10px 12px;border-radius:8px;border:2px solid var(--border);background:var(--card);color:var(--text);font-size:14px;font-weight:500}
    input:focus{outline:none;border-color:var(--accent)}
    table{width:100%;border-collapse:collapse}
    td,th{padding:10px;border-bottom:1px solid var(--border);font-size:13px;text-align:left}
    th{font-weight:700;color:var(--mut);text-transform:uppercase;font-size:11px;letter-spacing:0.5px}
    .status-open{color:var(--mut)}
    .status-won{color:var(--accent);font-weight:700}
    .status-lost{color:#ff4444;font-weight:700}
    .status-push{color:var(--warn);font-weight:700}
    .diag{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
    .header-bar{background:var(--bg-dark);padding:12px 16px;border-bottom:2px solid var(--border);margin-bottom:16px}
    .logo{font-size:20px;font-weight:800;color:var(--accent);letter-spacing:-0.5px}
    .market-header{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--mut);margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid var(--border)}
    .slip-item{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;min-width:200px}

    /* Table Layout for Game Cards */
    .game-card{background:var(--card);border-radius:12px;padding:16px;margin:16px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);border:1px solid var(--border)}
    .game-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid var(--border)}
    .game-title{font-size:18px;font-weight:700;color:var(--text)}
    .game-meta{color:var(--mut);font-size:13px;margin-top:4px}
    .sgp-badge{background:var(--accent);color:#000;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:800;letter-spacing:0.5px}

    /* Betting Table */
    .bet-table{width:100%;border-collapse:collapse}
    .bet-table thead th{text-align:center;padding:12px 8px;font-size:11px;font-weight:700;color:var(--mut);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--border)}
    .bet-table tbody td{padding:0;border-bottom:1px solid var(--border)}
    .bet-table tbody tr:last-child td{border-bottom:none}
    .player-name{padding:12px;font-weight:600;color:var(--text)}
    .bet-cell{padding:12px 8px;text-align:center;cursor:pointer;transition:all .2s;background:transparent}
    .bet-cell:hover{background:var(--card-hover)}
    .bet-cell.selected{background:var(--selected-cell);border:2px solid var(--accent)}
    .bet-cell.disabled{opacity:0.4;cursor:not-allowed;pointer-events:none}
    .line-value{font-size:14px;font-weight:700;color:var(--text);margin-bottom:2px}
    .odds-value{font-size:13px;color:var(--accent);font-weight:600}

    /* Series Winner Card */
    .series-card{background:var(--card);border-radius:12px;padding:16px;margin:16px 0;border:2px solid var(--accent)}
    .series-header{font-size:16px;font-weight:700;color:var(--text);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}
    .series-option{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-dark);border-radius:8px;margin:8px 0;cursor:pointer;transition:all .2s;border:2px solid transparent}
    .series-option:hover{background:var(--card-hover)}
    .series-option.selected{border-color:var(--accent);background:var(--selected-cell)}
    .series-player{font-size:15px;font-weight:700}
    .series-odds{font-size:18px;font-weight:800;color:var(--accent)}

    /* Enhanced Bet Slip */
    .slip-legs{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;max-height:200px;overflow-y:auto}
    .slip-leg{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .leg-info{flex:1}
    .leg-market{font-size:10px;color:var(--mut);text-transform:uppercase;font-weight:600;margin-bottom:4px}
    .leg-selection{font-size:13px;font-weight:700;color:var(--text);margin-bottom:2px}
    .leg-odds{font-size:14px;color:var(--accent);font-weight:700}
    .leg-remove{background:transparent;border:1px solid var(--border);color:var(--mut);padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:700;transition:all .2s}
    .leg-remove:hover{background:var(--warn);color:#000;border-color:var(--warn)}
    .slip-summary{background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px}
    .summary-row{display:flex;justify-content:space-between;margin:6px 0;font-size:14px}
    .summary-label{color:var(--mut);font-weight:600}
    .summary-value{color:var(--text);font-weight:700}
    .summary-value.highlight{color:var(--accent);font-size:16px}

    /* Mobile Responsive */
    @media (max-width: 768px){
      .bet-table thead th{font-size:10px;padding:8px 4px}
      .player-name{font-size:13px}
      .line-value{font-size:12px}
      .odds-value{font-size:11px}
    }
  </style>
</head>
<body>
<div class="header-bar">
  <div style="max-width:1100px;margin:0 auto" class="between">
    <div class="logo">‚ö° TOUR SPORTSBOOK</div>
    <div class="row">
      <input id="userId" type="text" placeholder="Enter your name" style="width:180px"/>
      <button class="btn small" onclick="saveUser()">Save</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="between">
      <div class="tabs">
        <div id="tab-odds" class="tab active" onclick="showTab('odds')">Odds Board</div>
        <div id="tab-bets" class="tab" onclick="showTab('bets')">My Bets</div>
      </div>
      <div class="row" style="gap:12px">
        <div class="row" style="gap:6px">
          <span class="mut">Balance:</span>
          <span id="coins" style="font-weight:800;font-size:18px;color:var(--accent)">‚Äî</span>
          <span class="mut">coins</span>
        </div>
        <button class="btn small" onclick="refreshAll()">‚Üª Refresh</button>
        <button class="btn small" onclick="reprice()">‚ö° Reprice</button>
      </div>
    </div>
  </div>

  <!-- Odds board -->
  <div id="screen-odds">
    <div id="board"></div>
  </div>

  <!-- My Bets -->
  <div id="screen-bets" style="display:none">
    <div class="card">
      <div class="between">
        <h2>Betting History</h2>
        <button class="btn small" onclick="loadMyBets()">‚Üª Refresh</button>
      </div>
    </div>
    <div class="card">
      <div id="betsTable" style="overflow-x:auto">Loading‚Ä¶</div>
    </div>
  </div>
</div>

<!-- Bet Slip -->
<div class="slip">
  <div class="between" style="margin-bottom:12px">
    <div class="row" style="gap:10px">
      <div style="font-size:16px;font-weight:800;color:var(--text)">BET SLIP</div>
      <div style="background:var(--accent);color:#000;padding:4px 10px;border-radius:12px;font-weight:800;font-size:13px" id="slipCount">0</div>
    </div>
    <button class="btn small" onclick="clearSlip()">Clear All</button>
  </div>
  <div id="slipLegs" class="slip-legs"></div>
  <div id="slipSummary" class="slip-summary" style="display:none"></div>
  <div class="grid">
    <div><input id="stake" type="number" min="1" placeholder="Enter stake (coins)" style="font-size:15px"/></div>
    <button class="btn primary" onclick="placeSlip()">Place Bet</button>
  </div>
  <div class="mut" id="slipNote" style="margin-top:8px;font-size:11px;text-align:center">Add bets to build your slip</div>
</div>

<script>
  // ===== State =====
  let odds = [];
  let slip = [];
  let betsTimer = null;
  const $ = sel => document.querySelector(sel);

  // ===== Tabs =====
  function showTab(name){
    $('#tab-odds').classList.toggle('active', name==='odds');
    $('#tab-bets').classList.toggle('active', name==='bets');
    $('#screen-odds').style.display = name==='odds' ? '' : 'none';
    $('#screen-bets').style.display = name==='bets' ? '' : 'none';
    if (name==='bets'){
      loadMyBets();
      if (betsTimer) clearInterval(betsTimer);
      betsTimer = setInterval(loadMyBets, 10000);
    } else {
      if (betsTimer) { clearInterval(betsTimer); betsTimer = null; }
    }
  }

  // ===== User & Wallet =====
  function saveUser(){
    const id = $('#userId').value.trim() || 'guest';
    localStorage.setItem('tsb_user', id);
    loadWallet();
    if ($('#tab-bets').classList.contains('active')) loadMyBets();
  }
  function loadUser(){
    const id = localStorage.getItem('tsb_user') || 'guest';
    $('#userId').value = id;
    return id;
  }
  function loadWallet(){
    google.script.run.withSuccessHandler(w=>{
      $('#coins').textContent = (w && typeof w.coins_balance==='number') ? Math.round(w.coins_balance) : '‚Äî';
    }).getWallet(loadUser());
  }

  // ===== Odds Board =====
  function fmtOdds(n){ n = Number(n||0); return (n>0?'+':'') + n; }

  function renderBoard(){
    const host = $('#board');
    host.innerHTML = '';
    if (!odds.length){
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<div class="mut">No events found. Check Events & Lines tabs (and redeploy the web app after code changes).</div>`;
      host.appendChild(card);

      google.script.run.withSuccessHandler(d=>{
        const diag = document.createElement('div');
        diag.className = 'card diag';
        diag.innerText = JSON.stringify(d, null, 2);
        host.appendChild(diag);
      }).getOddsBoardDebug();
      return;
    }

    odds.forEach(ev=>{
      const dateTxt = (ev.date ? new Date(ev.date).toLocaleString() : '');

      // Check which markets exist for this event
      const hasSeries = ev.markets.some(m=>m.market==='SERIES_WINNER');
      const hasML = ev.markets.some(m=>m.market==='ML');
      const hasOU = ev.markets.some(m=>m.market==='OU');
      const hasSpread = ev.markets.some(m=>(m.market||'').toUpperCase()==='SPREAD');

      // Handle H2H Series separately
      if (hasSeries){
        const card = document.createElement('div');
        card.className = 'series-card';
        const seriesMarkets = ev.markets.filter(m => m.market === 'SERIES_WINNER');

        card.innerHTML = `
          <div class="series-header">üèÜ Best of 3 Series Winner</div>
          <div style="margin-bottom:8px;color:var(--mut);font-size:13px">${ev.map_label || ('Event '+ev.event_id)} ‚Ä¢ ${dateTxt}</div>
        `;

        seriesMarkets.forEach(m => {
          const opt = document.createElement('div');
          opt.className = 'series-option';
          opt.innerHTML = `
            <span class="series-player">${m.selection}</span>
            <span class="series-odds">${fmtOdds(m.american_odds)}</span>
          `;
          opt.onclick = () => addToSlip({
            event_id: ev.event_id,
            market: m.market,
            selection: m.selection,
            param: "",
            odds: m.american_odds
          });
          card.appendChild(opt);
        });

        host.appendChild(card);
        return;
      }

      // Regular tour events
      const card = document.createElement('div');
      card.className='card';

      card.innerHTML = `
        <div class="between" style="margin-bottom:16px">
          <div>
            <div class="mut" style="margin-bottom:4px">${dateTxt}</div>
            <h2>${ev.map_label || ('Event '+ev.event_id)}</h2>
            <div class="mut" style="margin-top:2px">Event ID: ${ev.event_id}</div>
          </div>
          <span class="pill">${ev.series || 'Tour'} ‚Ä¢ ${ev.mode || 'stroke'}</span>
        </div>

        ${hasML ? '<div class="market-header">Moneyline</div><div class="odds" id="ml_'+ev.event_id+'"></div>' : ''}
        ${hasSpread ? '<div class="market-header">Head-to-Head Spread</div><div class="odds" id="sp_'+ev.event_id+'"></div>' : ''}
        ${hasOU ? '<div class="market-header">Player Over/Under</div><div class="odds" id="ou_'+ev.event_id+'"></div>' : ''}
      `;
      host.appendChild(card);

      // ===== ML tickets
      if (hasML) {
        const mlDiv = $('#ml_'+ev.event_id);
        ev.markets.filter(m=>m.market==='ML').forEach(m=>{
          const t=document.createElement('div'); t.className='ticket';
          t.innerHTML = `
            <div class="big">${m.selection}</div>
            <div class="mut">Moneyline</div>
            <div class="odds-value">${fmtOdds(m.american_odds)}</div>
            <button class="btn small" style="margin-top:8px;width:100%">Add to Slip</button>
          `;
          t.querySelector('button').onclick=()=>addToSlip({event_id: ev.event_id, market:'ML', selection:m.selection, param:m.param, odds:Number(m.american_odds)});
          mlDiv.appendChild(t);
        });
      }

      // ===== OU tickets grouped by player/line (supports multi-word names)
      if (hasOU) {
        const ouDiv = $('#ou_'+ev.event_id);
        const ouGroups = {};
        ev.markets.filter(m=>m.market==='OU').forEach(m=>{
          const player = String(m.selection).replace(/\s+(UNDER|OVER)$/i,'');
          const key = player + '|' + (m.param||'');
          if (!ouGroups[key]) {
            ouGroups[key] = {player:player, line:m.param, under:null, over:null};
          }
          if (/\sUNDER$/i.test(m.selection)) ouGroups[key].under=m; else ouGroups[key].over=m;
        });
        Object.values(ouGroups).forEach(g=>{
          if (!g.under || !g.over) return;
          const t=document.createElement('div'); t.className='ticket';
          t.innerHTML=`
            <div class="big">${g.player}</div>
            <div class="mut" style="margin:6px 0">Total: ${g.line}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
              <div style="text-align:center">
                <div style="font-size:11px;color:var(--mut);margin-bottom:4px">UNDER</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(g.under.american_odds)}</div>
              </div>
              <div style="text-align:center">
                <div style="font-size:11px;color:var(--mut);margin-bottom:4px">OVER</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(g.over.american_odds)}</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px">
              <button class="btn small btn-under">Under</button>
              <button class="btn small btn-over">Over</button>
            </div>
          `;
          t.querySelector('.btn-under').onclick=()=>addToSlip({event_id: ev.event_id, market:'OU', selection:g.under.selection, param:g.under.param, odds:Number(g.under.american_odds)});
          t.querySelector('.btn-over').onclick=()=>addToSlip({event_id: ev.event_id, market:'OU', selection:g.over.selection,  param:g.over.param,  odds:Number(g.over.american_odds)});
          ouDiv.appendChild(t);
        });
      }

      // ===== SPREAD tickets (robust parse + grouping) - FIXED
      if (hasSpread) {
        const spDiv = $('#sp_'+ev.event_id);
        const spGroups = {};
        const spreadMarkets = ev.markets.filter(m => (m.market||'').toUpperCase() === 'SPREAD');

        console.log('Spread markets found:', spreadMarkets.length, 'for event', ev.event_id);

        spreadMarkets.forEach(m=>{
          // Parse player and numeric line from selection string
          let player = '', line = null;
          const selStr = String(m.selection||'');
          const mm = selStr.match(/^(.*)\s+([+-]?\d+(?:\.\d+)?)$/);

          if (mm) {
            player = mm[1].trim();
            line = Number(mm[2]);
          }

          // If param exists and is valid, use it for the line value (it should be signed correctly from backend)
          if (m.param !== undefined && m.param !== null && m.param !== "" && !isNaN(Number(m.param))) {
            line = Number(m.param);
          }

          console.log('Parsed spread:', {player, line, selection: m.selection, param: m.param});

          if (!player || !isFinite(line)) {
            console.warn('Invalid spread data:', m);
            return;
          }

          const key = String(Math.abs(line).toFixed(1));     // group by absolute value
          const label = Math.abs(line).toFixed(1);

          // Initialize group if it doesn't exist (compatible with older JS engines)
          if (!spGroups[key]) {
            spGroups[key] = { label: label, sides: {} };
          }

          // Store with numeric param for slip
          spGroups[key].sides[player] = {
            selection: m.selection,
            american_odds: m.american_odds,
            param: line,
            market: m.market
          };
        });

        console.log('Spread groups:', spGroups);

        Object.values(spGroups).forEach(g=>{
          const players = Object.keys(g.sides);
          if (players.length < 2) {
            console.warn('Not enough players for spread group:', g);
            return;
          }

          players.sort();
          const p1 = players[0], p2 = players[1];
          const m1 = g.sides[p1], m2 = g.sides[p2];

          const t = document.createElement('div');
          t.className='ticket';
          t.style.minWidth = '280px';
          t.innerHTML = `
            <div class="mut" style="margin-bottom:8px">SPREAD ${g.label}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <div style="text-align:center;padding:8px;background:var(--card);border-radius:6px">
                <div style="font-size:13px;font-weight:700;margin-bottom:4px">${p1}</div>
                <div style="font-size:12px;color:var(--mut);margin-bottom:4px">${m1.selection.match(/[+-]\d+(?:\.\d+)?$/)?.[0] || ''}</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(m1.american_odds)}</div>
              </div>
              <div style="text-align:center;padding:8px;background:var(--card);border-radius:6px">
                <div style="font-size:13px;font-weight:700;margin-bottom:4px">${p2}</div>
                <div style="font-size:12px;color:var(--mut);margin-bottom:4px">${m2.selection.match(/[+-]\d+(?:\.\d+)?$/)?.[0] || ''}</div>
                <div class="odds-value" style="font-size:15px">${fmtOdds(m2.american_odds)}</div>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
              <button class="btn small btn-spread-a">${p1}</button>
              <button class="btn small btn-spread-b">${p2}</button>
            </div>
          `;
          t.querySelector('.btn-spread-a').onclick = () => addToSlip({
            event_id: ev.event_id,
            market: 'SPREAD',
            selection: m1.selection,
            param: m1.param,
            odds: Number(m1.american_odds)
          });
          t.querySelector('.btn-spread-b').onclick = () => addToSlip({
            event_id: ev.event_id,
            market: 'SPREAD',
            selection: m2.selection,
            param: m2.param,
            odds: Number(m2.american_odds)
          });
          spDiv.appendChild(t);
        });
      }
    });
  }

  // ===== Slip =====
  function amToDecimal(am){
    const a = Number(am);
    return a >= 0 ? 1 + a/100 : 1 + 100/Math.abs(a);
  }

  function calculateParlayOddsFrontend(legs, isSameEvent){
    let dec = 1;
    legs.forEach(l => { dec *= amToDecimal(l.odds); });
    if (isSameEvent && legs.length >= 2) dec *= 0.97;  // 3% correlation adjustment
    return dec >= 2 ? Math.round((dec-1)*100) : Math.round(-100/(dec-1));
  }

  function addToSlip(sel){
    // Allow same-game parlays - no restriction on event_id
    slip.push(sel);
    renderSlip();
  }

  function clearSlip(){ slip=[]; renderSlip(); }

  function renderSlip(){
    const legs = $('#slipLegs');
    const summary = $('#slipSummary');
    $('#slipCount').textContent = slip.length;

    // Render legs
    legs.innerHTML = '';
    if (slip.length === 0){
      legs.innerHTML = '<div class="mut" style="text-align:center;padding:20px">Add bets to build your slip</div>';
    } else {
      slip.forEach((leg, idx) => {
        const div = document.createElement('div');
        div.className = 'slip-leg';
        div.innerHTML = `
          <div class="leg-info">
            <div class="leg-market">${leg.market} ‚Ä¢ Event ${leg.event_id}</div>
            <div class="leg-selection">${leg.selection}</div>
            ${leg.param ? `<div class="mut" style="font-size:11px">Line: ${leg.param}</div>` : ''}
            <div class="leg-odds">${fmtOdds(leg.odds)}</div>
          </div>
          <button class="leg-remove">√ó</button>
        `;
        div.querySelector('.leg-remove').onclick = () => {
          slip.splice(idx, 1);
          renderSlip();
        };
        legs.appendChild(div);
      });
    }

    // Render summary
    if (slip.length === 0){
      summary.style.display = 'none';
    } else if (slip.length === 1){
      summary.style.display = 'block';
      const dec = amToDecimal(slip[0].odds);
      const stake = Number($('#stake').value || 0);
      const payout = stake > 0 ? (stake * dec).toFixed(2) : '‚Äî';
      summary.innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Type:</span>
          <span class="summary-value">Single Bet</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Odds:</span>
          <span class="summary-value">${fmtOdds(slip[0].odds)}</span>
        </div>
        ${stake > 0 ? `
          <div class="summary-row">
            <span class="summary-label">Potential Payout:</span>
            <span class="summary-value highlight">$${payout}</span>
          </div>
        ` : ''}
      `;
    } else {
      // Parlay
      summary.style.display = 'block';
      const events = new Set(slip.map(l => l.event_id));
      const isSameEvent = events.size === 1;
      const parlayOdds = calculateParlayOddsFrontend(slip, isSameEvent);
      const dec = amToDecimal(parlayOdds);
      const stake = Number($('#stake').value || 0);
      const payout = stake > 0 ? (stake * dec).toFixed(2) : '‚Äî';

      summary.innerHTML = `
        <div class="summary-row">
          <span class="summary-label">Type:</span>
          <span class="summary-value">${isSameEvent ? 'Same Game Parlay' : 'Parlay'} (${slip.length} legs)</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Combined Odds:</span>
          <span class="summary-value">${fmtOdds(parlayOdds)}</span>
        </div>
        ${stake > 0 ? `
          <div class="summary-row">
            <span class="summary-label">Potential Payout:</span>
            <span class="summary-value highlight">$${payout}</span>
          </div>
        ` : ''}
      `;
    }

    // Update note
    $('#slipNote').textContent = slip.length>1 ? 'Parlay bet - All legs must win' : slip.length===1 ? 'Single bet - Enter stake and place' : 'Add bets to build your slip';
  }

  // ===== Backend hooks =====
  function refreshAll(){
    google.script.run
      .withSuccessHandler(data=>{ odds = data || []; renderBoard(); loadWallet(); })
      .withFailureHandler(err=>{ alert('Failed to load board: '+(err && err.message ? err.message : err)); })
      .getOddsBoard();
  }
  function reprice(){
    google.script.run
      .withSuccessHandler(res=>{
        if (!res || !res.ok){ alert('Reprice failed' + (res && res.error ? (': '+res.error) : '')); return; }
        refreshAll();
      })
      .withFailureHandler(err=> alert('Reprice error: '+(err && err.message ? err.message : err)))
      .repriceNow();
  }
  function placeSlip(){
    const id = loadUser();
    const stake = Number($('#stake').value||0);
    if (!stake || stake<=0){ alert('Enter a stake > 0'); return; }
    if (!slip.length){ alert('No selections'); return; }
    const payload = slip.length===1
      ? { user_id:id, stake, type:'single', selection:slip[0] }
      : { user_id:id, stake, type:'parlay', legs:slip };
    google.script.run
      .withSuccessHandler(res=>{
        if (res && res.ok){
          $('#stake').value='';
          clearSlip();
          loadWallet();
          loadMyBets();
          alert('Bet placed!');
        } else {
          alert('Failed to place bet.');
        }
      })
      .withFailureHandler(err=> alert('Error: '+(err && err.message ? err.message : err)))
      .placeBet(payload);
  }

  // ===== My Bets =====
  function loadMyBets(){ google.script.run.withSuccessHandler(renderMyBets).listMyBets(loadUser()); }
  function renderMyBets(rows){
    const host=$('#betsTable');
    if (!rows||!rows.length){ host.textContent='No bets yet.'; return; }
    let html=`<table><thead><tr><th>Time</th><th>Type</th><th>Event</th><th>Selection</th><th>Line</th><th>Odds</th><th>Stake</th><th>Status</th><th>Payout</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      const ts=r.timestamp?new Date(r.timestamp).toLocaleString():'';
      const type=(String(r.is_parlay)==="TRUE"||r.is_parlay===true)?'PARLAY':r.market;
      const raw=(r.status||'open').toLowerCase();
      const statusDisplay = raw==='open' ? 'PENDING' : raw.toUpperCase();
      const cls = raw==='won'?'status-won':raw==='lost'?'status-lost':raw==='push'?'status-push':'status-open';
      html+=`<tr class="${cls}">
        <td>${ts}</td><td>${type}</td><td>${r.event_id||''}</td>
        <td>${r.selection||''}</td><td>${r.param||''}</td>
        <td>${(Number(r.odds)>0?'+':'')+Number(r.odds)}</td><td>${Math.round(Number(r.stake||0))}</td>
        <td style="text-transform:none">${statusDisplay}</td>
        <td>${r.settled_payout?Math.round(Number(r.settled_payout)):''}</td>
      </tr>`;
    });
    host.innerHTML=html+'</tbody></table>';
  }

  // ===== Boot =====
  (function init(){
    loadUser();
    refreshAll();
    renderSlip();
    // Update slip summary when stake changes
    $('#stake').addEventListener('input', renderSlip);
  })();
</script>
</body>
</html>
